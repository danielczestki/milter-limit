#!/usr/bin/env perl

use strict;
use FindBin qw($RealBin);
use lib "$RealBin/../lib";

use Getopt::Long;
use Milter::Limit;
use Milter::Limit::Util;
use Proc::PID::File;

my %opts = (
    debug  => 0,                            # debugging mode
    config => '/etc/mail/milter-limit.conf' # config file
);

GetOptions(\%opts, 'debug|d', 'config|c=s');

main();

sub main {
    my $config = Milter::Limit::Config->instance($opts{config});

    Milter::Limit::Util::daemonize() unless $opts{debug};

    die "already running" if Proc::PID::File->running;

    $0 = $$config{name} || 'milter-limit';

    my $milter = Milter::Limit->instance('BerkeleyDB');

    # XXX drop privs
    $milter->register;
    $milter->main;
}
